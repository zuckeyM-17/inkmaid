# Inkmaid プロジェクト - Cursor AI ルール

## プロジェクト概要

Inkmaidは、手書きとAIで直感的に図解するフルスタックプラットフォームです。
ブラウザ上での手書き入力とAIエージェントによる論理的な構造操作を融合し、
Mermaid図（フローチャート、ER図、シーケンス図等）を作成・編集・管理できます。

## 技術スタック

- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript 5 (厳格モード)
- **API**: tRPC v11 (型安全なクライアント/サーバー通信)
- **Database**: PostgreSQL 16 + Drizzle ORM
- **Styling**: Tailwind CSS 4
- **AI**: Vercel AI SDK
- **Linter/Formatter**: Biome
- **Package Manager**: pnpm (workspace)
- **Container**: Docker Compose

## コーディング規約

### 一般原則

- 常に日本語でコメントとドキュメントを記述する
- TypeScriptの型を明示的に定義する（anyは使用禁止）
- 関数やコンポーネントにはJSDocコメントを付ける
- エラーハンドリングを適切に行う

### ファイル命名規則

- コンポーネント: PascalCase (`DiagramCanvas.tsx`)
- ユーティリティ/フック: camelCase (`useDiagram.ts`, `parseStroke.ts`)
- 定数: SCREAMING_SNAKE_CASE (`MAX_STROKE_COUNT`)

### ディレクトリ構成

```
apps/web/src/
├── app/           # Next.js App Router ページ
├── components/    # Reactコンポーネント
├── lib/           # ユーティリティ、クライアント設定
└── server/        # サーバーサイドロジック
    ├── db/        # Drizzle スキーマ・クライアント
    └── trpc/      # tRPC ルーター
```

### React/Next.js

- Server Componentsをデフォルトとして使用
- Client Componentsには `"use client"` を明示
- `use` プレフィックスでカスタムフックを命名
- コンポーネントは関数宣言で定義（アロー関数ではなく）

```tsx
// Good
export default function DiagramCanvas() { ... }

// Avoid
const DiagramCanvas = () => { ... }
```

### tRPC

- ルーターは `apps/web/src/server/trpc/routers/` に配置
- 入力バリデーションには Zod を使用
- エラーは TRPCError を使用して適切に処理

```typescript
import { z } from "zod";
import { publicProcedure, router } from "../init";

export const exampleRouter = router({
  create: publicProcedure
    .input(z.object({ name: z.string().min(1) }))
    .mutation(async ({ ctx, input }) => {
      // 処理
    }),
});
```

### Drizzle ORM

- スキーマは `apps/web/src/server/db/schema.ts` に定義
- テーブル名はスネークケース、カラム名もスネークケース
- 型エクスポートは `$inferSelect` と `$inferInsert` を使用

```typescript
export const projects = pgTable("projects", {
  id: uuid("id").defaultRandom().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export type Project = typeof projects.$inferSelect;
export type NewProject = typeof projects.$inferInsert;
```

### Tailwind CSS

- ユーティリティクラスを直接使用
- 複雑なスタイルは `cn()` ヘルパーでクラスを結合
- レスポンシブデザインを考慮（mobile-first）

### 状態管理

- サーバー状態: tRPC + TanStack Query
- クライアント状態: React useState/useReducer
- グローバル状態が必要な場合: Zustand を検討

## コマンド

| コマンド | 説明 |
|---------|------|
| `pnpm setup` | worktree用の環境変数を自動設定 |
| `pnpm setup:default` | デフォルトポート（5432, 3000）で環境設定 |
| `pnpm dev:all` | DB起動 → 開発サーバー起動 |
| `pnpm db:push` | スキーマをDBに反映 |
| `pnpm db:status` | Dockerコンテナの状態を確認 |
| `pnpm lint:fix` | Biomeで自動修正 |
| `pnpm test` | テスト実行 |

## 重要なファイル

- `apps/web/src/server/db/schema.ts` - DBスキーマ定義
- `apps/web/src/server/trpc/routers/` - APIルーター
- `apps/web/src/lib/trpc/` - tRPCクライアント設定
- `doc/develop.md` - 設計ドキュメント

## 注意事項

- `pnpm` を使用（npm/yarn は使用しない）
- 環境変数は `.env.local` に設定（.envはルートのDocker用）
- Biomeのルールに従う（ESLint/Prettierは使用しない）
- コミット前に `pnpm lint:fix` を実行
- git worktree使用時は `pnpm setup` で環境を初期化
- **lint-staged設定**: `biome format --write`は使用せず、`biome check --write`を使用（フォーマットも含む）

## AI開発時のガイドライン

1. 新しい機能を追加する際は、まず `doc/develop.md` の設計を確認する
2. tRPCルーターを追加したら `apps/web/src/server/trpc/routers/index.ts` に登録する
3. DBスキーマを変更したら `pnpm db:push` を実行する
4. Server ComponentsとClient Componentsを適切に分離する
5. エラーメッセージは日本語で、ユーザーフレンドリーに記述する
6. **作業の終わりに `doc/logs/` の開発ログを更新する**
   - ディレクトリ構造: `doc/logs/YYYY/MM/` （年/月でまとめる）
   - ファイル名: `YYYYMMDD.md` または `YYYYMMDD-N.md`（同日複数回の場合）
   - 例: `doc/logs/2025/12/20251221-1.md`
   - 内容: 実装した機能、追加/変更したファイル、次のステップ
7. **APIを追加・変更したら `doc/api-reference.md` を更新する**
   - tRPCルーターの新規追加・変更
   - REST APIエンドポイントの追加
   - 型定義の変更
   - 使用例のコード追加
8. **機能を完了したら `doc/TODO.md` を更新する**
   - 完了したタスクを「🟢 完了済み」セクションに移動
   - 新しいタスクがあれば優先度に応じて追加
   - 「最終更新」の日付を更新
9. **🔴 必須: タスク完了時に必ずlintチェックを実行する**
   - 作業を完了する前に、必ず `pnpm lint` を実行してエラーがないことを確認する
   - エラーがある場合は `pnpm lint:fix` で自動修正を試みる
   - 自動修正できないエラーは手動で修正する
   - lintエラーが解消されるまで作業を完了としない
10. **🔴 必須: lint-staged設定の統一ルール**
    - `package.json`の`lint-staged`設定を変更する際は、必ず以下の設定を使用する：
      ```json
      "lint-staged": {
        "*.{ts,tsx,js,jsx}": ["biome check --write"],
        "*.{json,md}": ["biome check --write"]
      }
      ```
    - ❌ **禁止**: `biome format --write`を直接使用しない（lint-stagedから呼び出すとエラーになる可能性がある）
    - ✅ **推奨**: すべてのファイルタイプで`biome check --write`を使用（フォーマットも含む）
    - `package.json`を変更した後は、lint-stagedの設定が正しいか確認すること
    - lint-stagedの設定を変更した場合は、必ず`pnpm lint-staged --help`で動作確認すること

## 作業完了前のCIチェック（必須）

**🔴 AIは作業を完了する前に、必ず以下のチェックを実行すること：**

### 必須チェック（AIが自動実行）

1. **Lintチェック（必須）**
   ```bash
   pnpm lint
   ```
   - エラーがある場合は `pnpm lint:fix` で自動修正を試みる
   - 自動修正できないエラーは手動で修正する
   - lintエラーが解消されるまで作業を完了としない

2. **型チェック（必須）**
   ```bash
   pnpm --filter web exec tsc --noEmit
   ```
   - TypeScriptの型エラーがないことを確認
   - 型エラーがある場合は修正する
   - 型エラーが解消されるまで作業を完了としない

3. **ビルドチェック（オプション）**
   ```bash
   DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy pnpm build
   ```
   - 大きな変更を行った場合や、ビルドに影響する可能性がある変更の場合に実行
   - Next.jsのビルドが成功することを確認
   - ビルドエラーがある場合は修正する

### チェック項目の説明

| チェック | コマンド | 説明 | 必須度 |
|---------|---------|------|--------|
| Lint | `pnpm lint` | Biomeによるコードスタイル・構文チェック | 🔴 必須 |
| Type Check | `pnpm --filter web exec tsc --noEmit` | TypeScriptの型エラーチェック | 🔴 必須 |
| Build | `DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy pnpm build` | Next.jsのビルドが成功するか確認 | 🟢 オプション |

### 自動修正コマンド

```bash
# Biomeの自動修正
pnpm lint:fix
```

**重要**:
- AIは作業完了時に必ずLintチェックと型チェックを実行し、エラーがないことを確認すること
- エラーがある場合は、ユーザーに報告する前に修正すること
- Lintチェックと型チェックに通過するまで作業を完了としないこと
- ビルドチェックは大きな変更の場合に実行することを推奨
- **package.jsonを変更した場合**: lint-staged設定が正しいか確認すること（`biome check --write`を使用）
- これらのチェックに失敗するとCIが失敗します。PRを作成する前に必ず通過させてください。
