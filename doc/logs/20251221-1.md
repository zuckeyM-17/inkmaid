# 開発ログ: 2025-12-21

## 概要

Inkmaidプロジェクトの基盤構築（Phase 1）を実施。pnpm ワークスペース、Docker環境、PostgreSQL、Drizzle ORM、tRPCのセットアップを完了。

---

## 1. pnpm ワークスペースのセットアップ

### 作成したファイル

- `package.json` - ルートのパッケージ設定（workspaces, scripts）
- `pnpm-workspace.yaml` - pnpm ワークスペース設定
- `apps/web/package.json` - Next.js アプリのパッケージ設定
- `biome.json` - Biome リンター/フォーマッター設定
- `.gitignore` - Git除外設定

### ディレクトリ構成

```
.
├── apps/web/          # Next.js アプリケーション
├── doc/               # プロジェクトドキュメント
│   ├── develop.md     # 設計ドキュメント
│   └── logs/          # 開発ログ
├── package.json
├── pnpm-workspace.yaml
└── biome.json
```

---

## 2. Docker + PostgreSQL 環境

### 作成したファイル

- `docker-compose.yml` - 開発用（PostgreSQLのみ）
- `docker-compose.prod.yml` - 本番用（PostgreSQL + Next.js）
- `.env` - 環境変数
- `.env.example` - 環境変数サンプル

### PostgreSQL 設定

| 項目 | 値 |
|-----|-----|
| Image | postgres:16-alpine |
| User | inkmaid |
| Password | inkmaid_password |
| Database | inkmaid |
| Port | 5432 |

### コマンド

```bash
pnpm db:up       # PostgreSQL起動
pnpm db:down     # PostgreSQL停止
pnpm db:logs     # ログ表示
pnpm db:reset    # データ削除して再起動
```

---

## 3. Next.js アプリケーション

### 技術スタック

- Next.js 15 (App Router)
- React 19
- TypeScript 5
- Tailwind CSS 4

### 作成したファイル

```
apps/web/
├── src/
│   ├── app/
│   │   ├── layout.tsx      # ルートレイアウト（TRPCProvider含む）
│   │   ├── page.tsx        # トップページ（テスト用UI）
│   │   ├── globals.css     # Tailwind CSS
│   │   └── api/trpc/[trpc]/route.ts  # tRPC APIエンドポイント
│   ├── lib/trpc/
│   │   ├── client.ts       # tRPCクライアント
│   │   └── provider.tsx    # TRPCProvider
│   └── server/
│       ├── db/
│       │   ├── schema.ts   # Drizzleスキーマ
│       │   └── index.ts    # DBクライアント
│       └── trpc/
│           ├── init.ts     # tRPC初期化
│           └── routers/
│               ├── diagram.ts  # diagramRouter
│               └── index.ts    # appRouter
├── drizzle.config.ts
├── next.config.ts
├── postcss.config.mjs
├── tsconfig.json
├── Dockerfile              # 本番用
└── .dockerignore
```

---

## 4. Drizzle ORM

### データベーススキーマ

5つのテーブルを定義:

1. **projects** - プロジェクト（図）の基本情報
2. **diagram_versions** - Mermaidコードのバージョン履歴
3. **chat_sessions** - AIエージェントとの対話セッション
4. **chat_messages** - チャットメッセージ履歴
5. **handwriting_strokes** - 手書きデータ

### コマンド

```bash
pnpm db:push      # スキーマをDBに反映
pnpm db:generate  # マイグレーションファイル生成
pnpm db:migrate   # マイグレーション実行
pnpm db:studio    # Drizzle Studio起動
```

---

## 5. tRPC

### 実装したエンドポイント

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `diagram.listProjects` | Query | プロジェクト一覧取得 |
| `diagram.createProject` | Mutation | プロジェクト作成 |
| `diagram.getProject` | Query | プロジェクト詳細取得 |
| `diagram.getVersionHistory` | Query | バージョン履歴取得 |
| `diagram.saveVersion` | Mutation | 新バージョン保存 |

### クライアント側

- `@trpc/react-query` + `@tanstack/react-query` を使用
- `TRPCProvider` でアプリ全体をラップ

---

## 6. 本番用 Docker

### Dockerfile

マルチステージビルドを採用:

1. **base** - pnpm有効化
2. **deps** - 依存関係インストール
3. **builder** - Next.jsビルド（standalone出力）
4. **runner** - 本番実行（non-rootユーザー）

### コマンド

```bash
pnpm prod:build   # 本番イメージビルド
pnpm prod:up      # 本番環境起動（DB + Web）
pnpm prod:down    # 本番環境停止
pnpm prod:logs    # ログ表示
```

---

## 7. ドキュメント整備

### 作成したファイル

- `README.md` - プロジェクトのREADME（クイックスタート、コマンド一覧等）
- `.cursorrules` - Cursor AI用のリポジトリプロンプト
- `LICENSE` - MITライセンス

---

## 開発ワークフロー

### 開発時

```bash
pnpm dev:all      # DB起動 → Next.js開発サーバー起動
# http://localhost:3000 でアクセス
```

### 本番デプロイ

```bash
pnpm prod:build   # Dockerイメージビルド
pnpm prod:up      # コンテナ起動
# http://localhost:3000 でアクセス
```

---

## 次のステップ（Phase 2）

- [ ] 手書きCanvas (Konva.js) の実装
- [ ] Mermaid.js によるダイアグラム描画
- [ ] Vercel AI SDK による AIチャットボットの実装

---

## 参考

- 設計ドキュメント: `doc/develop.md`

