# 開発ログ: 2025-12-22 (6)

## 概要

Git worktree を使った複数環境構築のサポートを追加しました。
同じMac上で複数のworktreeを同時に開発できるよう、Docker Composeの名前やポートが重複しない仕組みを構築しました。

---

## 1. 実装した機能

### Git Worktree 対応

- **自動ポート割り当て**: ディレクトリ名のハッシュ値から一意なポートを自動計算
- **プロジェクト分離**: `COMPOSE_PROJECT_NAME` を使用してDockerコンテナとボリュームを分離
- **セットアップスクリプト**: `pnpm setup` で環境変数を自動生成

### ポート割り当ての仕組み

- ディレクトリ名のMD5ハッシュから0-99のオフセットを計算
- PostgreSQL: `5432 + offset`
- Next.js: `3000 + offset`
- 同じディレクトリ名なら常に同じポートが割り当てられる

---

## 変更したファイル

```
.
├── docker-compose.yml         # 環境変数対応に修正
├── env.example                # 環境変数の例
├── package.json               # setup, setup:default, db:status コマンド追加
├── scripts/
│   └── setup-worktree.sh      # worktreeセットアップスクリプト（新規）
├── .cursorrules               # コマンドとworktree注意事項を追加
├── .claude/
│   └── README.md              # Git Worktree セクションとコマンドを追加
└── doc/
    └── development-guide.md   # Git Worktree セクション追加
```

---

## 使い方

### 新しいworktreeを作成

```bash
# worktreeを作成
git worktree add ../inkmaid-feature-auth feature/auth

# worktreeに移動
cd ../inkmaid-feature-auth

# 依存関係をインストール
pnpm install

# 環境をセットアップ（.envと.env.localを自動生成）
pnpm setup

# 開発開始
pnpm dev:all
```

### デフォルトポート（5432, 3000）を使用

```bash
# メインリポジトリ向け
pnpm setup:default
```

### 手動でポートを指定

```bash
DB_PORT=5433 NEXT_PORT=3001 pnpm setup
```

---

## 技術的な詳細

### docker-compose.yml の変更点

- `container_name`: `${COMPOSE_PROJECT_NAME:-inkmaid}-db`
- `ports`: `${DB_PORT:-5432}:5432`
- `volumes.name`: `${COMPOSE_PROJECT_NAME:-inkmaid}_postgres_data`

これにより、環境変数でプロジェクト名とポートを指定可能になりました。

---

## 次のステップ

- [ ] CI/CDでのworktree対応テスト
- [ ] docker-compose.prod.yml も同様に環境変数対応

