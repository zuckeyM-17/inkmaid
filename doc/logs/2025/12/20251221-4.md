# 開発ログ: 2025-12-21 (4)

## 概要

Phase 2 のコア機能として、以下を実装：
1. **Vercel AI SDK の導入**
2. **手書きストロークからAIでMermaid変換（メイン機能）**
3. **テキストチャットは補助機能として配置**

---

## 1. パッケージのインストール

```bash
pnpm add ai @ai-sdk/openai --filter web
```

| パッケージ | 説明 |
|-----------|------|
| `ai` | Vercel AI SDK |
| `@ai-sdk/openai` | OpenAIプロバイダー |

---

## 2. 手書きストローク解釈API

### 新しいエンドポイント: `ai.interpretStrokes`

手書きストロークの座標データを分析し、ユーザーの意図を推測してMermaidコードを更新する。

#### 入力

```typescript
z.object({
  strokes: z.array(strokeSchema),   // 手書きストロークデータ
  currentMermaidCode: z.string(),   // 現在のMermaidコード
  hint: z.string().optional(),      // 補足説明（オプション）
})
```

#### ストローク解釈ロジック

各ストロークから以下の情報を抽出してAIに渡す：
- 点数
- バウンディングボックス（範囲）
- 中心座標
- サイズ（幅 x 高さ）
- 閉じた形状かどうか
- アスペクト比

#### 解釈ルール（AIプロンプト）

| 形状 | 解釈 |
|------|------|
| 四角形 | ノード（処理ブロック） |
| ひし形 | 条件分岐 |
| 円形 | 開始/終了ノード |
| 線・矢印 | ノード間の接続 |
| X印 | 要素の削除 |

---

## 3. UIの見直し

### Before（チャットメイン）

```
┌────────────┬─────────────────────┬──────────────┐
│ サイドバー  │  DiagramCanvas      │  ChatPanel   │
│            │                     │  (大きい)     │
└────────────┴─────────────────────┴──────────────┘
```

### After（手書きメイン）

```
┌──────────┬──────────────────────────────────────┐
│サイドバー │  ヘッダー [💬 テキストで指示]         │
│ (w-64)   ├──────────────────────────────────────┤
│          │  [テキスト入力] ← 展開時のみ表示      │
│          ├──────────────────────────────────────┤
│          │  [AI結果フィードバック]               │
│          ├──────────────────────────────────────┤
│          │  ┌────────────────────────────────┐  │
│          │  │  🪄 AIで変換  |  💾 保存       │  │
│          │  ├────────────────────────────────┤  │
│          │  │                                │  │
│          │  │   手書きキャンバス (大きい)      │  │
│          │  │                                │  │
│          │  └────────────────────────────────┘  │
│          │  <details>Mermaidコード</details>    │
└──────────┴──────────────────────────────────────┘
```

---

## 4. DiagramCanvasの変更

### 追加した機能

| 機能 | 説明 |
|------|------|
| **🪄 AIで変換ボタン** | ストロークをAIに送信してMermaidに変換 |
| **補足説明入力** | オプションでヒントを追加可能 |
| **変換中オーバーレイ** | AI処理中の視覚的フィードバック |
| **Mermaidコード折りたたみ** | `<details>` で折りたたみ、画面を広く使える |

### ストロークの色変更

```typescript
strokeColor="#7c3aed"  // violet-600（紫系に統一）
```

---

## 5. page.tsxの変更

### 主な変更点

1. **レイアウトをシンプル化** - チャットパネルを削除し、ヘッダーに小さな入力を配置
2. **テキスト入力は展開式** - 「💬 テキストで指示」ボタンで開閉
3. **AI結果のフィードバック** - 変換結果をバナーで表示
4. **キャンバスを大きく** - 1100 x 600 に拡大

### 新しいフロー

1. 手書きでストロークを描く
2. 「🪄 AIで変換」をクリック
3. （オプション）補足説明を入力
4. AIがストロークを解釈してMermaidを更新
5. ストロークは自動でクリア、新しい図が表示

---

## 6. 変更したファイル

```
apps/web/
├── package.json                      # ai, @ai-sdk/openai 追加
├── src/
│   ├── app/
│   │   └── page.tsx                  # レイアウト刷新、手書きメイン
│   ├── components/
│   │   ├── ChatPanel.tsx             # 既存（補助として残す）
│   │   └── DiagramCanvas.tsx         # AIで変換ボタン追加
│   └── server/
│       └── trpc/
│           └── routers/
│               └── ai.ts             # interpretStrokes追加
```

---

## 7. 環境変数

```bash
# apps/web/.env.local
OPENAI_API_KEY=sk-...
DATABASE_URL="postgresql://inkmaid:inkmaid_password@localhost:5432/inkmaid"
```

---

## 次のステップ

- [ ] 色・太さ選択のUIツールバー
- [ ] ストローク認識の精度向上（画像としてマルチモーダルで送信）
- [ ] バージョン履歴のタイムトラベルUI
- [ ] ジェスチャー認識（X印で削除など）

---

## 使用例

1. プロジェクトを選択
2. キャンバスに手書きで図形を描く
   - 四角形 → ノードになる
   - 矢印 → 接続になる
3. 「🪄 AIで変換」をクリック
4. （オプション）「上の四角は認証処理」などと補足
5. AIがMermaidコードを生成
6. ダイアグラムに反映 ✨

---

## 参考

- 設計ドキュメント: `doc/develop.md`
- 前回のログ: `doc/logs/20251221-3.md`
