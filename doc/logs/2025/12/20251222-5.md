# 開発ログ 2025-12-22 (6)

## 概要

バージョン履歴機能を実装。過去のバージョン一覧表示とロールバック機能を追加。

## 実装内容

### 1. ロールバックAPI追加

`diagram.rollbackToVersion` - 指定したバージョンの状態を新しいバージョンとして復元

- 選択したバージョンのMermaidコードを取得
- 新しいバージョンとして保存（履歴を破壊しない設計）
- ストロークデータも一緒にコピー
- 変更理由に「v{n} にロールバック」と記録

`diagram.getVersion` - 特定バージョンの詳細取得（プレビュー用）

### 2. VersionHistoryPanelコンポーネント作成

バージョン履歴を表示するサイドパネル:

- バージョン一覧を新しい順に表示
- 更新タイプに応じたアイコン（🆕作成 / ✏️手書き / 🤖AI）
- 最新バージョンには「最新」バッジ
- クリックで展開してMermaidコードをプレビュー
- 「この状態に戻す」ボタンで確認ダイアログ → ロールバック実行

### 3. プロジェクト詳細ページへの統合

- ヘッダーに「📜 履歴」トグルボタン追加
- バージョン履歴パネルをサイドバーとして表示
- ロールバック完了時にキャンバスを再レンダリング

## 追加/変更したファイル

- `apps/web/src/server/trpc/routers/diagram.ts` - rollbackToVersion, getVersion API追加
- `apps/web/src/components/VersionHistoryPanel.tsx` - 新規作成
- `apps/web/src/app/projects/[id]/page.tsx` - パネル統合

## 技術的なポイント

- ロールバックは「破壊的でない」設計（過去のバージョンを削除せず、新しいバージョンとして復元）
- tRPCのuseQueryで履歴を取得、useMutationでロールバック実行
- 確認ダイアログを2段階UI（ボタン → 確認/キャンセル）で実装

## 次のステップ

- タイムトラベルUI（スライダーで過去の状態を閲覧）
- Mermaidコードの差分表示

