# 開発ログ: 2025-12-21 (6)

## 概要

**flowchart以外の図に対応**し、サイドバーでプロジェクトの図の種類がわかるようにした。

---

## 1. サポートする図の種類

以下の5種類のMermaid図に対応：

| 種類 | アイコン | 説明 |
|------|----------|------|
| `flowchart` | 🔀 | フローチャート（処理の流れを表現） |
| `sequence` | ↔️ | シーケンス図（オブジェクト間のやり取り） |
| `classDiagram` | 📦 | クラス図（クラスの構造と関係） |
| `stateDiagram` | 🔄 | 状態遷移図（状態の変化を表現） |
| `erDiagram` | 🗄️ | ER図（データベース設計） |

---

## 2. DBスキーマの変更

### `projects`テーブルに`diagram_type`カラムを追加

```typescript
export const projects = pgTable("projects", {
  id: uuid("id").defaultRandom().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  /** 図の種類（flowchart, sequence, erDiagram など） */
  diagramType: varchar("diagram_type", { length: 50 })
    .notNull()
    .default("flowchart"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

---

## 3. 図の種類ごとの初期テンプレート

各図の種類に応じた初期Mermaidコードを定義：

```typescript
export const DIAGRAM_TEMPLATES: Record<DiagramType, string> = {
  flowchart: `flowchart TD
    A[開始] --> B{条件}
    B -->|Yes| C[処理1]
    ...`,
  sequence: `sequenceDiagram
    participant User as ユーザー
    participant System as システム
    ...`,
  // ... 他の図の種類も同様
};
```

---

## 4. プロジェクト作成UIの改善

### 図の種類選択ドロップダウンを追加

```
┌─────────────────────────────────────┐
│ 新規プロジェクト名...               │
├─────────────────────────────────────┤
│ ▼ 🔀 フローチャート                 │  ← 図の種類を選択
│   ↔️ シーケンス図                   │
│   📦 クラス図                       │
│   🔄 状態遷移図                     │
│   🗄️ ER図                          │
├─────────────────────────────────────┤
│ [+ 新規作成]                        │
└─────────────────────────────────────┘
```

---

## 5. サイドバーのプロジェクト一覧改善

各プロジェクトにアイコンと図の種類を表示：

```
┌─────────────────────────────────────┐
│ プロジェクト                        │
├─────────────────────────────────────┤
│ 🔀 認証フロー                       │
│    フローチャート · 2025/12/21      │
├─────────────────────────────────────┤
│ ↔️ API連携                          │
│    シーケンス図 · 2025/12/20        │
├─────────────────────────────────────┤
│ 🗄️ ユーザーDB                       │
│    ER図 · 2025/12/19                │
└─────────────────────────────────────┘
```

---

## 6. AIプロンプトの図の種類対応

### 図の種類ごとの構文ルール

```typescript
const DIAGRAM_SYNTAX_RULES: Record<DiagramType, string> = {
  flowchart: `## フローチャート (flowchart) の構文
- \`flowchart TD\` (上から下) または \`flowchart LR\` (左から右) で始まる
- ノードの定義: \`A[テキスト]\`, \`B{条件}\`...`,
  sequence: `## シーケンス図 (sequenceDiagram) の構文
- \`sequenceDiagram\` で始まる
- 参加者: \`participant A as エイリアス\`...`,
  // ... 他の図の種類も同様
};
```

### 図の種類ごとのストローク解釈ルール

```typescript
const DIAGRAM_STROKE_RULES: Record<DiagramType, string> = {
  flowchart: `## ストロークの解釈ルール（フローチャート）
- 四角形に近い形 → ノード（処理ブロック）の追加
- ひし形に近い形 → 条件分岐の追加...`,
  sequence: `## ストロークの解釈ルール（シーケンス図）
- 縦の直線 → 新しい参加者の追加
- 横向きの矢印 → メッセージの追加...`,
  // ... 他の図の種類も同様
};
```

---

## 7. 変更したファイル

```
apps/web/src/
├── app/
│   └── page.tsx                      # 図の種類選択UI、サイドバーアイコン表示
├── server/
│   ├── db/
│   │   └── schema.ts                 # diagramType追加、DIAGRAM_TYPES定義
│   └── trpc/
│       └── routers/
│           ├── ai.ts                 # diagramType対応プロンプト生成
│           └── diagram.ts            # createProjectにdiagramType追加
```

---

## 8. マイグレーション

```bash
# DBスキーマを反映
DATABASE_URL="postgresql://inkmaid:inkmaid_password@localhost:5432/inkmaid" \
  npx drizzle-kit push
```

---

## 次のステップ

### 優先度高
- [ ] **AI思考ログをリアルタイム表示**
  - 右サイドバーにストリーミング表示
  - 推論過程を可視化してデバッグしやすく
- [ ] **プロジェクト管理機能**
  - プロジェクトの削除・名前変更

### 中優先度
- [ ] プロジェクトのバージョン履歴遡り
- [ ] 色・太さ選択のUIツールバー
- [ ] バージョン履歴のタイムトラベルUI
- [ ] 囲み線でグループ化（subgraph）
- [ ] 矢印の向きの認識改善

### 完了済み
- [x] ~~flowchart以外の図に対応~~ ✅
- [x] ~~サイドバーで図の種類を表示~~ ✅
- [x] ~~ストローク認識の精度向上（画像としてマルチモーダルで送信）~~ ✅
- [x] ~~ジェスチャー認識（X印で削除など）~~ ✅

---

## 参考

- 設計ドキュメント: `doc/develop.md`
- 前回のログ: `doc/logs/20251221-5.md`

