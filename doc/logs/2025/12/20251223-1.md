# 2025/12/23 開発ログ #1 - Langfuse導入

## 概要

LLMアプリケーションのオブザーバビリティ向上のため、Langfuseを導入しました。

## 実装内容

### 1. Docker Composeへのサービス追加

`docker-compose.yml` にLangfuse関連のサービスを追加：

- **langfuse**: Langfuse Web UI（ポート3001）
- **langfuse-worker**: バックグラウンド処理ワーカー
- **langfuse-postgres**: Langfuse専用PostgreSQL（ポート5433）
- **langfuse-clickhouse**: トレースデータ用ClickHouse
- **langfuse-redis**: キャッシュ用Redis
- **langfuse-minio**: S3互換オブジェクトストレージ（ポート9090）

Langfuse v3の公式構成に合わせて、`CLICKHOUSE_CLUSTER_ENABLED=false` を設定し、シングルノードで動作するように構成。

### 2. Langfuse SDKのインストール

`langfuse` パッケージ（v3.38.6）をインストール。

### 3. Langfuseクライアントの実装

`apps/web/src/lib/langfuse/client.ts` を作成：

- シングルトンパターンでLangfuseクライアントを管理
- 環境変数が未設定の場合はnullを返す（オプショナル統合）
- ローカル開発とSaaS両方に対応

### 4. AI呼び出しへのトレーシング統合

`apps/web/src/app/api/ai/interpret-stream/route.ts` を更新：

- トレース開始時にメタデータを記録（図の種類、ストローク数など）
- Generationスパンで入出力を記録
- ストリーミング完了時に結果をフラッシュ
- エラー発生時もエラー情報を記録

### 5. ドキュメント作成

`doc/langfuse-setup.md` にセットアップ手順を文書化：

- ローカル開発環境でのセットアップ手順
- SaaS版への移行方法
- トラブルシューティング

## 追加/変更したファイル

- `docker-compose.yml` - Langfuseサービスを追加
- `env.example` - Langfuse関連の環境変数を追加
- `apps/web/package.json` - langfuseパッケージを追加
- `apps/web/src/lib/langfuse/client.ts` - 新規作成
- `apps/web/src/app/api/ai/interpret-stream/route.ts` - トレーシング統合
- `doc/langfuse-setup.md` - 新規作成

## 使用方法

1. `docker compose up -d` でLangfuseを起動
2. http://localhost:3001 でアカウント作成・APIキー取得
3. `apps/web/.env.local` に環境変数を設定
4. 開発サーバーを起動してAI機能を使用
5. Langfuse UIでトレースを確認

## 次のステップ

- Langfuseのプロンプト管理機能の活用を検討
- コスト分析ダッシュボードの構築
- 本番環境でのLangfuse Cloud導入

