# 開発ログ: 2025-12-22 (#4) - キャンバスのズーム・パン機能実装

## 実装内容

### 手書きキャンバスのズーム・パン機能

Konva.jsのStageコンポーネントを拡張し、キャンバスのズーム・パン操作を実装しました。

#### 機能詳細

1. **ズーム機能**
   - マウスホイールでズームイン/ズームアウト
   - ポインター位置を中心にズーム
   - ズーム範囲: 25% 〜 400%
   - UIボタン（+/-）でもズーム可能

2. **パン機能（キャンバス移動）**
   - `Space`キー + ドラッグで移動
   - ミドルクリック（ホイールボタン）+ ドラッグで移動
   - パン中はカーソルが`grab`/`grabbing`に変化

3. **ズームコントロールUI**
   - 左上に配置（+/-ボタン、倍率表示）
   - 倍率クリックで100%にリセット
   - 右下に操作ヒント表示

4. **Mermaidレイヤーとの連動**
   - 手書きレイヤーとMermaidプレビューが同期
   - CSS transformで両レイヤーが同じズーム・パン状態を共有

---

## 変更ファイル

### 追加・変更

| ファイル | 変更内容 |
|---------|---------|
| `apps/web/src/components/HandwritingCanvas.tsx` | ズーム・パン機能、座標変換、ViewTransform型追加 |
| `apps/web/src/components/DiagramCanvas.tsx` | viewTransform状態管理、Mermaidレイヤーのtransform適用 |
| `apps/web/src/components/DynamicHandwritingCanvas.tsx` | ViewTransform型の再エクスポート |
| `doc/TODO.md` | ズーム・パン機能を完了済みに移動 |

---

## 技術的なポイント

### 座標変換

ズーム・パン状態を考慮してポインター座標をキャンバス座標に変換：

```typescript
const getTransformedPointerPosition = (stage: Konva.Stage) => {
  const pos = stage.getPointerPosition();
  if (!pos) return null;
  return {
    x: (pos.x - viewTransform.x) / viewTransform.scale,
    y: (pos.y - viewTransform.y) / viewTransform.scale,
  };
};
```

### 親コンポーネントでの状態共有

```typescript
// DiagramCanvas.tsx
const [viewTransform, setViewTransform] = useState<ViewTransform>({
  scale: 1,
  x: 0,
  y: 0,
});

// Mermaidレイヤーに適用
const mermaidTransformStyle = {
  transform: `translate(${viewTransform.x}px, ${viewTransform.y}px) scale(${viewTransform.scale})`,
  transformOrigin: "0 0",
};
```

---

## 操作方法

| 操作 | 動作 |
|------|------|
| マウスホイール | ズームイン/アウト |
| Space + ドラッグ | パン（移動） |
| ミドルクリック + ドラッグ | パン（移動） |
| UIの + ボタン | ズームイン |
| UIの - ボタン | ズームアウト |
| 倍率表示クリック | 100%にリセット |

---

## 次のステップ

1. Langfuseの導入（LLMトレーシング）
2. バージョン履歴機能
3. 色・太さ選択のUIツールバー
4. タッチデバイスでのピンチズーム対応

