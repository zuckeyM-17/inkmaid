# 開発ログ: 2025-12-22 (1)

## 概要

**AI思考ログのリアルタイム表示**機能を実装。右サイドバーにストリーミングで思考過程を表示できるようになった。Cursor AIのように、1文字ずつリアルタイムで思考過程が流れる！

---

## 1. 実装した機能

### 右サイドバー: AI思考ログパネル

- 🧠 Claude Extended Thinkingを**リアルタイムでストリーミング表示**
- AIが解析中の思考過程が**1文字ずつ追加**されていく（Cursor AIのように！）
- 処理中はパルスアニメーションで状態を表示
- ヘッダーのトグルボタンでパネルの表示/非表示を切り替え
- 自動スクロールで最新のテキストが常に見える

### ストリーミングAPI（SSE形式）

- `/api/ai/interpret-stream` エンドポイントを新規作成
- Vercel AI SDKの `streamText` + `fullStream` を使用
- カスタムSSE（Server-Sent Events）ストリームを実装
- `reasoning-delta` と `text-delta` を分離してリアルタイム送信

### カスタムフック: `useAIStream`

- SSEストリームをパースして状態管理
- 思考過程（`thinkingText`）と出力（`outputText`）を分離
- AbortControllerによるキャンセル機能
- リアルタイムでUIを更新

---

## 2. 変更したファイル

### 新規作成

```
apps/web/src/
├── app/
│   └── api/
│       └── ai/
│           └── interpret-stream/
│               └── route.ts          # SSEストリーミングAPIエンドポイント
├── components/
│   └── AIThinkingPanel.tsx           # AI思考ログパネルコンポーネント
└── lib/
    └── hooks/
        └── useAIStream.ts            # SSEストリーミング管理フック
```

### 変更

```
apps/web/src/
└── app/
    └── page.tsx                      # レイアウト変更、ストリーミング統合
```

---

## 3. UI構成

```
┌─────────────┬───────────────────────────────┬──────────────┐
│ 左サイドバー │       メインコンテンツ         │ 右サイドバー │
│             │                               │              │
│ プロジェクト │   ┌─────────────────────┐    │  🧠 AI思考   │
│ 一覧        │   │                     │    │   ログ       │
│             │   │   DiagramCanvas     │    │              │
│             │   │                     │    │ 💭 Thinking  │
│             │   │   (手書き+Mermaid)   │    │ ...ストロー │
│             │   │                     │    │ クを分析...  │
│             │   │                     │    │              │
│             │   └─────────────────────┘    │ ✅ Result    │
│             │                               │ ノードを追加 │
└─────────────┴───────────────────────────────┴──────────────┘
```

---

## 4. ストリーミングのデータフロー

```
1. ユーザーが「AIで変換」をクリック
       ↓
2. useAIStream.interpretStrokes() を呼び出し
       ↓
3. fetch() で /api/ai/interpret-stream にPOST
       ↓
4. サーバー側で streamText() を実行
       ↓
5. SSE形式でチャンクを返却
   - typeCode "g" → 思考過程 (thinkingText)
   - typeCode "0" → 出力テキスト (outputText)
       ↓
6. クライアントで ReadableStream を読み取り
       ↓
7. AIThinkingPanel にリアルタイム表示
       ↓
8. 完了後、Mermaidコードをパースして更新
```

---

## 5. 技術的なポイント

### カスタムSSEストリーム

`toTextStreamResponse()` ではなく、`fullStream` を使ってカスタムSSEを作成：

```typescript
// サーバー側
for await (const part of result.fullStream) {
  if (part.type === "reasoning-delta") {
    // 思考過程をSSEで送信
    controller.enqueue(encoder.encode(`data: ${JSON.stringify({
      type: "reasoning",
      text: part.text,
    })}\n\n`));
  } else if (part.type === "text-delta") {
    // 出力テキストをSSEで送信
    controller.enqueue(encoder.encode(`data: ${JSON.stringify({
      type: "text-delta",
      text: part.text,
    })}\n\n`));
  }
}
```

### クライアント側のSSEパース

```typescript
// SSEイベントをパース
for (const line of lines) {
  if (!line.startsWith("data: ")) continue;
  const data = line.slice(6);
  const event = JSON.parse(data);
  
  if (event.type === "reasoning") {
    // 思考過程をリアルタイム更新
    thinkingBuffer += event.text;
    setState(prev => ({ ...prev, thinkingText: thinkingBuffer }));
  } else if (event.type === "text-delta") {
    // 出力テキストをリアルタイム更新
    outputBuffer += event.text;
    setState(prev => ({ ...prev, outputText: outputBuffer }));
  }
}
```

### ポイント

- `fullStream` で `reasoning-delta` と `text-delta` を分離取得
- カスタムSSEで両方を送信
- クライアントで分離してUIを更新
- 思考過程と最終出力が独立してリアルタイム表示される

---

## 6. 次のステップ

### 優先度高
- [ ] **プロジェクト管理機能**
  - プロジェクトの削除・名前変更

### 中優先度
- [ ] Langfuseの導入
- [ ] プロジェクトのバージョン履歴遡り
- [ ] 色・太さ選択のUIツールバー

### 完了済み
- [x] ~~AI思考ログをリアルタイム表示~~ ✅
- [x] ~~flowchart以外の図に対応~~ ✅
- [x] ~~サイドバーで図の種類を表示~~ ✅
- [x] ~~ストローク認識の精度向上~~ ✅
- [x] ~~ジェスチャー認識~~ ✅

---

## 参考

- 設計ドキュメント: `doc/develop.md`
- 前回のログ: `doc/logs/2025/12/20251221-6.md`

