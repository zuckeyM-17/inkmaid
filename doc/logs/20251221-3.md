# 開発ログ: 2025-12-21 (3)

## 概要

Phase 2 のコア機能として、以下を実装：
1. **ストロークデータのDB保存機能**
2. **Mermaidコードのバージョン管理**
3. **プロジェクト選択・編集フロー**

---

## 1. tRPCルーターの拡張

### 追加したエンドポイント

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `diagram.saveDiagramWithStrokes` | Mutation | Mermaidコードとストロークを一緒に保存 |
| `diagram.getProjectWithStrokes` | Query | プロジェクトの最新バージョンとストロークを取得 |

### saveDiagramWithStrokes の入力

```typescript
z.object({
  projectId: z.string().uuid(),
  mermaidCode: z.string(),
  strokes: z.array(strokeSchema),
  updateType: z.enum(["initial", "chat", "handwriting"]),
  reason: z.string().optional(),
})
```

### 処理フロー

1. 最新バージョン番号を取得
2. 新しい `diagram_versions` レコードを作成
3. `handwriting_strokes` にストロークデータを保存
4. プロジェクトの `updated_at` を更新

---

## 2. HandwritingCanvas の拡張

### 追加した機能

| 機能 | 説明 |
|------|------|
| `initialStrokes` prop | 初期ストロークデータを受け取る |
| `HandwritingCanvasRef` | refからメソッドを呼び出せるように |
| `forwardRef` 対応 | 親コンポーネントからref経由でアクセス可能 |

### HandwritingCanvasRef のメソッド

```typescript
export type HandwritingCanvasRef = {
  getStrokes: () => Stroke[];
  setStrokes: (strokes: Stroke[]) => void;
  clearStrokes: () => void;
};
```

---

## 3. DiagramCanvas の拡張

### 追加したProps

| Prop | 型 | 説明 |
|------|-----|------|
| `initialStrokes` | `Stroke[]` | 初期ストロークデータ |
| `isSaving` | `boolean` | 保存中の状態 |
| `onSave` | `(data) => void` | 保存ボタンのコールバック |

### 追加したUI要素

- **保存ボタン**: Mermaidコードとストロークを一緒に保存
- **未保存インジケータ**: 変更があることを視覚的に表示
- **デバッグ情報**: ストローク数とコード文字数を表示

---

## 4. プロジェクト選択・編集フロー

### page.tsx の変更

```
1. プロジェクト一覧から選択
2. 選択したプロジェクトのデータを取得
   - 最新のMermaidコード
   - 最新のストロークデータ
3. DiagramCanvasで編集
4. 保存ボタンで新バージョンとして保存
```

### 状態管理

```typescript
type SelectedProject = {
  id: string;
  name: string;
  mermaidCode: string;
  strokes: Stroke[];
};
```

---

## 5. データベース構造

### diagram_versions テーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | serial | プライマリキー |
| project_id | uuid | プロジェクトID |
| version_number | integer | バージョン番号 |
| mermaid_code | text | Mermaidコード |
| update_type | varchar | 更新タイプ |
| reason | text | 更新理由 |

### handwriting_strokes テーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | serial | プライマリキー |
| version_id | integer | バージョンID（FK） |
| stroke_data | jsonb | ストロークデータ（配列） |

---

## 6. 変更したファイル

```
apps/web/src/
├── app/
│   └── page.tsx                    # プロジェクト選択・編集フロー
├── components/
│   ├── HandwritingCanvas.tsx       # forwardRef対応、initialStrokes追加
│   └── DiagramCanvas.tsx           # 保存機能追加
└── server/
    └── trpc/
        └── routers/
            └── diagram.ts          # saveDiagramWithStrokes, getProjectWithStrokes追加
```

---

## 次のステップ

- [ ] 色・太さ選択のUIツールバー追加
- [ ] Vercel AI SDK によるAIチャットボットの実装
- [ ] 手書きストロークからAIへの送信機能
- [ ] バージョン履歴のタイムトラベルUI

---

## コマンド

```bash
# 開発サーバー起動
pnpm dev:all

# http://localhost:3000 または http://localhost:3004 でアクセス
```

---

## 動作確認

1. サイドバーから新規プロジェクトを作成
2. プロジェクトを選択
3. Mermaidコードを編集 or 手書きで描画
4. 「保存」ボタンをクリック
5. データがDBに保存される

---

## 参考

- 設計ドキュメント: `doc/develop.md`
- 前回のログ: `doc/logs/20251221-2.md`

